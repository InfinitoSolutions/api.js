name: Release Pipeline (master/1.0)

on:
  push:
    branches:
      # stable/1.0
      - prerelease/*

jobs:
  release-to-github:
    # release to github only when its a prerelease branch and auto merge label is triggered
    runs-on: ubuntu-latest
    steps:
    - uses: actions/setup-node@v1
      with:
        node-version: '15.3'
    - name: make release branch
      uses: peterjgrainger/action-create-branch@v2.0.1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        branch: "release/1.4.2"
    - name: package
      run: |
        yarn && yarn build
        npx lerna exec -- 'cp package.json build/'
        npx lerna exec -- 'cp README.md build/'
        npx lerna exec -- 'cp ../../LICENSE build/'
    - name: publish to npm
      env:
        NPM_KEY: ${{ secrets.NPM_KEY }}
      run: |
        echo "//registry.npmjs.org/:_authToken=${NPM_KEY}" > ~/.npmrc
        echo 'Publishing to npmjs.org.'
        npx lerna exec -- 'cd build && npm publish --access public'
